<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Making an Automated Google BigQuery Data Quality Monitor with Slack Alerts" /><meta property="og:locale" content="en" /><meta name="description" content="A guide on how to build a data quality regression testing suite for Google BigQuery, complete with Slack alerts" /><meta property="og:description" content="A guide on how to build a data quality regression testing suite for Google BigQuery, complete with Slack alerts" /><link rel="canonical" href="https://andrewmiller.online/posts/big-query-data-quality-monitor-slack/" /><meta property="og:url" content="https://andrewmiller.online/posts/big-query-data-quality-monitor-slack/" /><meta property="og:site_name" content="Andrew Miller Online" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-07-24T00:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Making an Automated Google BigQuery Data Quality Monitor with Slack Alerts" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-07-24T11:01:39-05:00","datePublished":"2022-07-24T00:00:00-05:00","description":"A guide on how to build a data quality regression testing suite for Google BigQuery, complete with Slack alerts","headline":"Making an Automated Google BigQuery Data Quality Monitor with Slack Alerts","mainEntityOfPage":{"@type":"WebPage","@id":"https://andrewmiller.online/posts/big-query-data-quality-monitor-slack/"},"url":"https://andrewmiller.online/posts/big-query-data-quality-monitor-slack/"}</script><title>Making an Automated Google BigQuery Data Quality Monitor with Slack Alerts | Andrew Miller Online</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Andrew Miller Online"><meta name="application-name" content="Andrew Miller Online"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/portrait.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Andrew Miller Online</a></div><div class="site-subtitle font-italic">Musing on data, Tableau CRM/Einstein Analytics, and development</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/projects/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>PROJECTS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/AndrewMillerOnline" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/andrewmilleronline/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Making an Automated Google BigQuery Data Quality Monitor with Slack Alerts</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Making an Automated Google BigQuery Data Quality Monitor with Slack Alerts</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1658638800" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 24, 2022 </em> </span> <span> Updated <em class="" data-ts="1658678499" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 24, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/username">Andrew Miller</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1937 words"> <em>10 min</em> read</span></div></div></div><div class="post-content"><h2 id="the-premise"><span class="mr-2">The Premise</span><a href="#the-premise" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Business Intelligence is all about using data to help drive decision making. Inherent in that definition is the assumption that the data is correct. In the real world, however, data can occasionally be wrong. Maybe your ETL script has a small bug. Maybe an upstream data source messed up. Maybe a DAG didn’t finish fully.</p><p>There are tons of possible causes, all with the same end result: your data is incomplete and/or incorrect. In my mind, the worst possible outcome in this situation is that you unknowingly surface that incorrect data to decision makers. This might incorrectly influence the decisions and frankly defeat the whole purpose of the business intelligence organization.</p><p>So if your data is wrong, you need to know. And you need to know immediately so that you can take corrective action. There are a lot of different approaches to doing this, and I’m going to break down how I accomplished it for my team.</p><h2 id="solution-overview"><span class="mr-2">Solution Overview</span><a href="#solution-overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Our team uses BigQuery to stage our data before ingesting it into CRM Analytics for end user consumption. Right now we do all our orchestration through cron scheduling of our Python ETL scripts, but we have plans to move to AirFlow for orchestration in the near future. Building out a cloud-native approach for the data quality testing suite that works with both our current and future orchestration was my top priority.</p><p>In a nutshell, the solution works like this:</p><ol><li>Tests are defined as BigQuery scheduled queries, with one scheduled query per table. Multiple tests are defined in each script, and a test failure will raise a SQL ERROR()<li>The scheduled query is either scheduled to run at certain times of the day or can be invoked on demand via Python<li>Scheduled query errors are published to a Pub/Sub topic<li>A cloud function subscribes to the Pub/Sub topic, so when it sees an error it then uses an Incoming Webhook to send a message to Slack<li>A Slack app receives the Incoming Webhook and sends the alert to your team’s Slack channel, alerting you in real-time to the data quality error.</ol><p>Tada!</p><p><img data-src="/assets/slack-data-quality-bot.png" alt="Screenshot of Slack alert" data-proofer-ignore></p><h2 id="why-i-like-this-approach"><span class="mr-2">Why I like this approach</span><a href="#why-i-like-this-approach" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>There are a few reasons why I like this approach that I think are worth sharing.</p><ol><li>Can be implemented entirely within the Free Tier of Google Cloud Platform, so there’s no additional cost.<li>Because it lives entirely within GCP there’s no additional software or platform required.<li>The regression tests are simple and easy-to-understand SQL, so anyone on your team can add to the test suite.</ol><h2 id="setup-guide"><span class="mr-2">Setup Guide</span><a href="#setup-guide" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>One of the beauties of this solution is that it’s relatively easy to set up: from start to finish, you can have your first test suite running in an hour or two. (Of course, if you’re working at a larger enterprise like mine, dealing with the Slack and GCP IAM permissions for some of these steps will add <em>days</em> to the process…)</p><h3 id="1-create-pubsub-topic"><span class="mr-2">1. Create Pub/Sub Topic</span><a href="#1-create-pubsub-topic" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The first step is to create your pub/sub topic. Give it a relevant topic id such as “data-alerts”.</p><p>The “Add a default subscription” checkbox is optional. You don’t need a default subscription for this process - the cloud function will create its own subscription - but it can be nice to have if you want to manually pull your failure event messages for troubleshooting purposes.</p><p>Leave the schema and message retention checkboxes unchecked. Checking the schema option will likely cause this process to fail, and there’s no need to retain the pub/sub messages because the failure events are already stored in StackDriver/Logs Explorer.</p><p><img data-src="/assets/pub-sub-topic-creation.png" alt="Pub/Sub topic creation" data-proofer-ignore></p><h3 id="2-create-destination-table"><span class="mr-2">2. Create Destination Table</span><a href="#2-create-destination-table" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now switch over to BigQuery. We need to create a new table that will store the results of successful test runs. Our scheduled query will use SELECT statements, and we have to specify a destination table to store the results of those SELECT statements or we’ll get an error. The upside to this is that this table can serve as a log of all your successful test runs, which is cool.</p><p>Give the table a relevant name such as <code class="language-plaintext highlighter-rouge">data_quality_test_results</code>, and create two columns:</p><blockquote><p><code class="language-plaintext highlighter-rouge">test_info (STRING)</code></p></blockquote><blockquote><p><code class="language-plaintext highlighter-rouge">etl_timestamp (TIMESTAMP)</code></p></blockquote><p><img data-src="/assets/test-table-creation.png" alt="Destination table creation" data-proofer-ignore></p><h3 id="3-create-scheduled-query"><span class="mr-2">3. Create Scheduled Query</span><a href="#3-create-scheduled-query" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now that we have a Pub/Sub topic to receive test failures and a destination table to store successful test runs, we’re ready to create our first test suite.</p><p>Within BigQuery, open a new editor window and construct a test similar to the following.</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre>  <span class="c1">-- This query will run a series of tests to ensure data quality within the new_table table</span>
  <span class="c1">-- Each query needs a test_info string formatted as "&lt;TEST_NAME&gt;::&lt;TABLE_NAME&gt;::"</span>
  <span class="c1">-- Ensure table isn't empty</span>
<span class="k">SELECT</span>
<span class="n">IF</span>
  <span class="p">(</span><span class="k">row_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">ERROR</span><span class="p">(</span><span class="n">test_info</span><span class="p">),</span>
    <span class="n">test_info</span><span class="p">)</span> <span class="k">AS</span> <span class="n">test_info</span><span class="p">,</span>
  <span class="k">CURRENT_TIMESTAMP</span><span class="p">()</span> <span class="k">AS</span> <span class="n">etl_timestamp</span>
<span class="k">FROM</span> <span class="p">(</span>
  <span class="k">SELECT</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="k">row_count</span><span class="p">,</span>
    <span class="nv">"Table is Empty::new_table::"</span> <span class="k">AS</span> <span class="n">test_info</span>
  <span class="k">FROM</span>
    <span class="nv">`my-project-name.test.new_table`</span> <span class="p">)</span>

<span class="k">UNION</span> <span class="k">ALL</span>

  <span class="c1">-- Ensure that first name and last name are either both provided or both null</span>
<span class="k">SELECT</span>
<span class="n">IF</span>
  <span class="p">(</span><span class="k">row_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">ERROR</span><span class="p">(</span><span class="n">test_info</span><span class="p">),</span>
    <span class="n">test_info</span><span class="p">)</span> <span class="k">AS</span> <span class="n">test_info</span><span class="p">,</span>
  <span class="k">CURRENT_TIMESTAMP</span><span class="p">()</span> <span class="k">AS</span> <span class="n">etl_timestamp</span>
<span class="k">FROM</span> <span class="p">(</span>
  <span class="k">SELECT</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="k">row_count</span><span class="p">,</span>
    <span class="nv">"Incomplete name fields::new_table::"</span> <span class="k">AS</span> <span class="n">test_info</span>
  <span class="k">FROM</span>
    <span class="nv">`my-project-name.test.new_table`</span>
  <span class="k">WHERE</span>
    <span class="p">(</span><span class="k">NOT</span><span class="p">(</span><span class="n">first_name</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">)</span>
      <span class="k">AND</span> <span class="n">last_name</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">)</span>
    <span class="k">OR</span> <span class="p">(</span><span class="n">first_name</span> <span class="k">IS</span> <span class="k">NULL</span>
      <span class="k">AND</span> <span class="k">NOT</span><span class="p">(</span><span class="n">last_name</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">))</span> <span class="p">)</span>
</pre></table></code></div></div><p>Now obviously this is a simple example, where I perform two tests:</p><ol><li>A check to ensure that the table has a row count greater than 0.<li>A check to ensure that all the records in this table either have no first_name/last_name or have both a first_name &amp; last_name.</ol><p>You’ll want to tweak the tests to suit your needs. The possibilities are endless, but you might:</p><ul><li>Check to ensure profit &gt; 0 each day<li>Check to ensure that join keys such as employee_id are coming through in the proper format (int versus float, etc)<li>Check to ensure the product_name field doesn’t contain erroneous or unexpected values.<li>Etc.</ul><p>The most important thing to remember is that the ERROR raised by each test contains a string with the test name and table name, each followed by two colons. We’ll need that string in the cloud function, so you can’t omit it.</p><h3 id="scheduling-the-query"><span class="mr-2">Scheduling the query</span><a href="#scheduling-the-query" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now that the query has been created, you need to schedule it. Press the Schedule button at the top of the editor window and create a new scheduled query.</p><p>First, give your query a name such as “Data Quality Test: table_name”. Following a set nomenclature like this will help you easily find the test suite you need if you have a lot of scheduled queries.</p><p>Next, choose how often to run the test. If your tables are refreshed every day at the same time, you can easily schedule the query to run a minute or two later.</p><p>If your tables aren’t refreshed on a predictable cadence, you can also choose the “On-demand” option from the Repeats dropdown. At that point, you can either use the web ui or the <a href="https://cloud.google.com/bigquery-transfer/docs/reference/datatransfer/rest/v1/projects.locations.transferConfigs/startManualRuns">Data Transfer API</a> to initiate your tests when needed.</p><p>Under the Destination for query results section, select the destination table you created in Step 2 above. Make sure the “Append to table” radio button is selected so that the table continues to aggregate all successful runs.</p><p>Finally, under the notification options section, enter the pub/sub topic you created in Step 1 above.</p><h3 id="4-create-slack-app"><span class="mr-2">4. Create Slack App</span><a href="#4-create-slack-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>It’s time to create our Slack app.</p><p>Go to the <a href="https://api.slack.com/apps">Slack Apps page</a> and click the Create New App button. Choose the ‘From scratch’ option, then give your app a killer name and choose the Workspace where you want this app to live.</p><p>Once the app is created, go to the Incoming Webhooks page and activate the feature. Scroll to the bottom of the page and click the “Add New Webhook to Workspace” button. Now select which channel your App should post alerts to and click ‘Allow’.</p><p>You’ll be returned to the Incoming Webhooks page where you can now see a URL that starts with <code class="language-plaintext highlighter-rouge">https://hooks.slack.com</code>. You’ll need this URL for the next step.</p><p>That’s it! Before moving on to the next step, you might want to give your app a sweet icon and meaningful description under the Basic Information section.</p><h3 id="5-create-cloud-function"><span class="mr-2">5. Create Cloud Function</span><a href="#5-create-cloud-function" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We’re almost done! We now have automated data quality tests running, which publish to a pub/sub topic when bad data is found. We also have a Slack app that will alert us to those test failures. We just need a relay to tie them together.</p><p>Head back to your Google Cloud console and open up Cloud Functions. Create a new function.</p><p>Set environment to 1st gen and give your function a name, such as “data-quality-slack-notification”.</p><p>Now under the Trigger section, select “Cloud Pub/Sub” as the trigger type and select the pub/sub topic you created earlier. Hit Save, then Next.</p><p>Cloud Functions support a number of runtimes, but I made this in Node.js so you’ll want to select Node.js 16 as the runtime.</p><p>Enter the following code into the package.json file:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"data-quality-slack-notification"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.0.1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"@google-cloud/pubsub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^0.18.0"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"@slack/webhook"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^6.1.0"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Now switch back to the index.js file, edit the entry point to “subscribe” and enter the following code:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="p">{</span><span class="nx">IncomingWebhook</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@slack/webhook</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">SLACK_WEBHOOK_URL</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">&lt;YOUR WEBHOOK URL FROM STEP3&gt;</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">webhook</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">IncomingWebhook</span><span class="p">(</span><span class="nx">SLACK_WEBHOOK_URL</span><span class="p">);</span>

<span class="c1">// subscribe is the main function called by Cloud Functions</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">subscribe</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">eventData</span> <span class="o">=</span> <span class="nx">getMessageData</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>

  <span class="c1">//Only send Slack messages on failures</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">errorStatus</span><span class="p">){</span>
	<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">eventData</span><span class="p">.</span><span class="nx">errorStatus</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>

  	<span class="c1">// Send message to Slack.</span>
  	<span class="kd">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">createSlackMessage</span><span class="p">(</span><span class="nx">eventData</span><span class="p">);</span>
  
  	<span class="nx">webhook</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Transform pubsub event message to a string</span>
<span class="kd">const</span> <span class="nx">getMessageData</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="dl">'</span><span class="s1">base64</span><span class="dl">'</span><span class="p">).</span><span class="nx">toString</span><span class="p">());</span>
<span class="p">}</span>

<span class="c1">// Create the Slack message</span>
<span class="kd">const</span> <span class="nx">createSlackMessage</span> <span class="o">=</span> <span class="p">(</span><span class="nx">eventData</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">messageParams</span> <span class="o">=</span> <span class="nx">eventData</span><span class="p">.</span><span class="nx">errorStatus</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">::</span><span class="dl">'</span><span class="p">);</span>

  <span class="kd">let</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span>
	<span class="dl">"</span><span class="s2">blocks</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
		<span class="p">{</span>
			<span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">header</span><span class="dl">"</span><span class="p">,</span>
			<span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
				<span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">plain_text</span><span class="dl">"</span><span class="p">,</span>
				<span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">:warning: Data Quality Test Failure</span><span class="dl">"</span><span class="p">,</span>
				<span class="dl">"</span><span class="s2">emoji</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span>
			<span class="p">}</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">section</span><span class="dl">"</span><span class="p">,</span>
			<span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
				<span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mrkdwn</span><span class="dl">"</span><span class="p">,</span>
				<span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">:</span> <span class="s2">`The test _</span><span class="p">${</span><span class="nx">messageParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span><span class="s2">_ has failed on table _</span><span class="p">${</span><span class="nx">messageParams</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span><span class="s2">_. &lt;https://console.cloud.google.com/bigquery?ws=!1m5!1m4!4m3!1s&lt;YOUR PROJECT ID&gt;!2s&lt;DATASET NAME&gt;!3s</span><span class="p">${</span><span class="nx">messageParams</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span><span class="s2">&amp;project=&lt;YOUR PROJECT ID&gt;|Open table in GBQ&gt;`</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">]</span>
<span class="p">};</span>

  <span class="k">return</span> <span class="nx">message</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>There’s two things you’ll need to edit in the code:</p><ol><li>First, put your Slack webhook URL into line 2.<li>Then, update line 43 with your GBQ project id and dataset. That section inserts a link into the Slack message to easily open the offending table in the GBQ web UI, so it needs to know which project and dataset your table is in.</ol><p>That’s it! Go ahead and deploy the code then give it a few minutes for the function to build.</p><h3 id="lets-test-it-out"><span class="mr-2">Let’s test it out</span><a href="#lets-test-it-out" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now that everything is configured, let’s run your first test suite. Go back into the scheduled queries interface and open your scheduled query. Click the “RUN TRANSFER NOW” link at the top of the page and initiate a one time transfer.</p><p>If everything is good with your data, then absolutely nothing will happen! We don’t want to make too much extra noise, so the cloud function will simply exit if there are no errors.</p><p>However, if there are any data errors, you should see a new Slack alert pop up about a minute after initiating the transfer run (it takes about a minute in my experience for the transfer runs to complete).</p><p><img data-src="/assets/dq-bot-working.png" alt="Our bot works" data-proofer-ignore></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/business-intelligence/'>Business Intelligence</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/crm-analytics/" class="post-tag no-text-decoration" >CRM Analytics</a> <a href="/tags/business-intelligence/" class="post-tag no-text-decoration" >Business Intelligence</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Making+an+Automated+Google+BigQuery+Data+Quality+Monitor+with+Slack+Alerts+-+Andrew+Miller+Online&url=https%3A%2F%2Fandrewmiller.online%2Fposts%2Fbig-query-data-quality-monitor-slack%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fandrewmiller.online%2Fposts%2Fbig-query-data-quality-monitor-slack%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Making+an+Automated+Google+BigQuery+Data+Quality+Monitor+with+Slack+Alerts+-+Andrew+Miller+Online&u=https%3A%2F%2Fandrewmiller.online%2Fposts%2Fbig-query-data-quality-monitor-slack%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fandrewmiller.online%2Fposts%2Fbig-query-data-quality-monitor-slack%2F&text=Making+an+Automated+Google+BigQuery+Data+Quality+Monitor+with+Slack+Alerts+-+Andrew+Miller+Online" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/saql-design-pattern-reshaping-long-wide-kansas-city-shuffle/">SAQL Design Pattern: Reshaping Long to Wide (The Kansas City Shuffle)</a><li><a href="/posts/case-against-monolithic-dataflows/">The Case Against Monolithic Dataflows</a><li><a href="/posts/big-query-data-quality-monitor-slack/">Making an Automated Google BigQuery Data Quality Monitor with Slack Alerts</a><li><a href="/posts/dataflow-extractor/">Dataflow Extractor</a><li><a href="/posts/creating-customer-value-at-Strava/">Creating Customer Value at Strava</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/development/">Development</a> <a class="post-tag" href="/tags/entrepreneurship/">Entrepreneurship</a> <a class="post-tag" href="/tags/business-intelligence/">Business Intelligence</a> <a class="post-tag" href="/tags/cryptography/">Cryptography</a> <a class="post-tag" href="/tags/einstein-analytics/">Einstein Analytics</a> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/sinocrypt/">SinoCrypt</a> <a class="post-tag" href="/tags/tableau-crm/">Tableau CRM</a> <a class="post-tag" href="/tags/agile/">Agile</a> <a class="post-tag" href="/tags/case-study/">Case Study</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/saql-design-pattern-reshaping-long-wide-kansas-city-shuffle/"><div class="card-body"> <em class="small" data-ts="1632891600" data-df="ll" > Sep 29, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>SAQL Design Pattern: Reshaping Long to Wide (The Kansas City Shuffle)</h3><div class="text-muted small"><p> Background When building dashboards, I frequently find myself needing to reshape data. Maybe it’s in a long format, but visually would make more sense as a wide table. Maybe it’s the other way ar...</p></div></div></a></div><div class="card"> <a href="/posts/case-against-monolithic-dataflows/"><div class="card-body"> <em class="small" data-ts="1648789200" data-df="ll" > Apr 1, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>The Case Against Monolithic Dataflows</h3><div class="text-muted small"><p> Background My project at work this quarter has been tackling various aspects of technical debt in our TCRM environment. Under that banner, one specific initiative that I spearheaded was to break d...</p></div></div></a></div><div class="card"> <a href="/posts/dataflow-extractor/"><div class="card-body"> <em class="small" data-ts="1646805600" data-df="ll" > Mar 9, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Dataflow Extractor</h3><div class="text-muted small"><p> About I created this simple web tool to assist in Tableau CRM/Einstein Analytics dataflow development. It allows users to view the datasets being registered within a given dataflow, and then isol...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/case-against-monolithic-dataflows/" class="btn btn-outline-primary" prompt="Older"><p>The Case Against Monolithic Dataflows</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">Andrew Miller</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/development/">Development</a> <a class="post-tag" href="/tags/entrepreneurship/">Entrepreneurship</a> <a class="post-tag" href="/tags/business-intelligence/">Business Intelligence</a> <a class="post-tag" href="/tags/cryptography/">Cryptography</a> <a class="post-tag" href="/tags/einstein-analytics/">Einstein Analytics</a> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/sinocrypt/">SinoCrypt</a> <a class="post-tag" href="/tags/tableau-crm/">Tableau CRM</a> <a class="post-tag" href="/tags/agile/">Agile</a> <a class="post-tag" href="/tags/case-study/">Case Study</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3"></p><button type="button" class="btn btn-primary" aria-label="Update"> </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-151381198-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-151381198-1'); }); </script>
